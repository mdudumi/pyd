// Translations
const translations = {
  en: {
    title: 'Pyd Planner',
    heading: 'Plan Your Day - Spiritual Growth',
    taskPlaceholder: 'Task title‚Ä¶',
    addTask: 'Add Task',
    searchPlaceholder: 'üîç Search tasks‚Ä¶',
    allCats: 'All Categories',
    allPrio: 'All Priorities',
    catGeneral: 'General',
    catReading: 'Reading',
    catPrayer: 'Prayer',
    catFellowship: 'Fellowship',
    catOutreach: 'Outreach',
    catFamily: 'Family',
    prioLow: 'Low Priority',
    prioMed: 'Medium Priority',
    prioHigh: 'High Priority',
    repeatNone: 'No Repeat',
    repeatDaily: 'Daily',
    repeatWeekly: 'Weekly',
    dueTitle: 'üîî Task Due',
    snooze: 'Snooze',
    dismiss: 'Dismiss',
    footer: '¬© 2025 Plan Your Day. All rights reserved.'
  },
  sq: {
    title: 'Pyd Planner',
    heading: 'Planifikoni Dit√´n - Rritje Shpirt√´rore',
    taskPlaceholder: 'Titulli i detyr√´s‚Ä¶',
    addTask: 'Shto Detyr√´n',
    searchPlaceholder: 'üîç K√´rko detyrat‚Ä¶',
    allCats: 'T√´ gjitha Kategorit√´',
    allPrio: 'T√´ gjitha Prioritetet',
    catGeneral: 'Gjenerale',
    catReading: 'Lexim',
    catPrayer: 'Lutje',
    catFellowship: 'V√´llaz√´ri',
    catOutreach: 'Arritje',
    catFamily: 'Familje',
    prioLow: 'Prioritet i ul√´t',
    prioMed: 'Prioritet mesatar',
    prioHigh: 'Prioritet i lart√´',
    repeatNone: 'Pa p√´rs√´ritje',
    repeatDaily: 'P√´rdit√´',
    repeatWeekly: 'Javor',
    dueTitle: 'üîî Detyra √´sht√´ af√´r',
    snooze: 'Merr m√´ von√´',
    dismiss: 'Anuloj',
    footer: '¬© 2025 Plan Your Day. T√´ gjitha t√´ drejtat e rezervuara.'
  },
  it: {
    title: 'Pyd Planner',
    heading: 'Pianifica la Giornata - Crescita Spirituale',
    taskPlaceholder: 'Titolo attivit√†‚Ä¶',
    addTask: 'Aggiungi Attivit√†',
    searchPlaceholder: 'üîç Cerca attivit√†‚Ä¶',
    allCats: 'Tutte le Categorie',
    allPrio: 'Tutte le Priorit√†',
    catGeneral: 'Generale',
    catReading: 'Lettura',
    catPrayer: 'Preghiera',
    catFellowship: 'Fellowship',
    catOutreach: 'Outreach',
    catFamily: 'Famiglia',
    prioLow: 'Bassa Priorit√†',
    prioMed: 'Priorit√† Media',
    prioHigh: 'Alta Priorit√†',
    repeatNone: 'Nessuna Ripetizione',
    repeatDaily: 'Quotidiana',
    repeatWeekly: 'Settimanale',
    dueTitle: 'üîî Attivit√† in scadenza',
    snooze: 'Posponi',
    dismiss: 'Ignora',
    footer: '¬© 2025 Plan Your Day. Tutti i diritti riservati.'
  },
  es: {
    title: 'Pyd Planner',
    heading: 'Planifica tu D√≠a - Crecimiento Espiritual',
    taskPlaceholder: 'T√≠tulo de la tarea‚Ä¶',
    addTask: 'Agregar Tarea',
    searchPlaceholder: 'üîç Buscar tareas‚Ä¶',
    allCats: 'Todas las Categor√≠as',
    allPrio: 'Todas las Prioridades',
    catGeneral: 'General',
    catReading: 'Lectura',
    catPrayer: 'Oraci√≥n',
    catFellowship: 'Comunidad',
    catOutreach: 'Alcance',
    catFamily: 'Familia',
    prioLow: 'Baja Prioridad',
    prioMed: 'Prioridad Media',
    prioHigh: 'Alta Prioridad',
    repeatNone: 'Sin Repetici√≥n',
    repeatDaily: 'Diaria',
    repeatWeekly: 'Semanal',
    dueTitle: 'üîî Tarea Pendiente',
    snooze: 'Posponer',
    dismiss: 'Descartar',
    footer: '¬© 2025 Plan Your Day. Todos los derechos reservados.'
  },
  fr: {
    title: 'Pyd Planner',
    heading: 'Planifiez Votre Journ√©e - Croissance Spirituelle',
    taskPlaceholder: 'Titre de la t√¢che‚Ä¶',
    addTask: 'Ajouter T√¢che',
    searchPlaceholder: 'üîç Rechercher t√¢ches‚Ä¶',
    allCats: 'Toutes les Cat√©gories',
    allPrio: 'Toutes les Priorit√©s',
    catGeneral: 'G√©n√©ral',
    catReading: 'Lecture',
    catPrayer: 'Pri√®re',
    catFellowship: 'Communaut√©',
    catOutreach: 'Sensibilisation',
    catFamily: 'Famille',
    prioLow: 'Priorit√© Basse',
    prioMed: 'Priorit√© Moyenne',
    prioHigh: 'Priorit√© Haute',
    repeatNone: 'Pas de R√©p√©tition',
    repeatDaily: 'Quotidienne',
    repeatWeekly: 'Hebdomadaire',
    dueTitle: 'üîî T√¢che Due',
    snooze: 'Rappeler',
    dismiss: 'Ignorer',
    footer: '¬© 2025 Plan Your Day. Tous droits r√©serv√©s.'
  },
  de: {
    title: 'Pyd Planner',
    heading: 'Plane deinen Tag - Spirituelles Wachstum',
    taskPlaceholder: 'Aufgabenname‚Ä¶',
    addTask: 'Aufgabe Hinzuf√ºgen',
    searchPlaceholder: 'üîç Aufgaben suchen‚Ä¶',
    allCats: 'Alle Kategorien',
    allPrio: 'Alle Priorit√§ten',
    catGeneral: 'Allgemein',
    catReading: 'Lesen',
    catPrayer: 'Gebet',
    catFellowship: 'Gemeinschaft',
    catOutreach: 'Outreach',
    catFamily: 'Familie',
    prioLow: 'Niedrige Priorit√§t',
    prioMed: 'Mittlere Priorit√§t',
    prioHigh: 'Hohe Priorit√§t',
    repeatNone: 'Keine Wiederholung',
    repeatDaily: 'T√§glich',
    repeatWeekly: 'W√∂chentlich',
    dueTitle: 'üîî Aufgabe f√§llig',
    snooze: 'Verschieben',
    dismiss: 'Verwerfen',
    footer: '¬© 2025 Plan Your Day. Alle Rechte vorbehalten.'
  }
};

function applyTranslations(lang) {
  document.documentElement.setAttribute('lang', lang);
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang][key]) el.textContent = translations[lang][key];
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (translations[lang][key]) el.placeholder = translations[lang][key];
  });
}

// Wire up flags
document.querySelectorAll('.flag').forEach(btn =>
  btn.addEventListener('click', () => applyTranslations(btn.dataset.lang))
);
applyTranslations('en');

// Theme toggle
const themeToggle = document.getElementById('theme-toggle'),
      iconSun     = document.getElementById('icon-sun'),
      iconMoon    = document.getElementById('icon-moon');
themeToggle.onclick = () => {
  const isDark = document.documentElement.classList.toggle('dark');
  iconSun.classList.toggle('hidden', !isDark);
  iconMoon.classList.toggle('hidden', isDark);
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
};

document.addEventListener('DOMContentLoaded', () => {
  const KEY = 'pyd-tasks';
  let tasks = JSON.parse(localStorage.getItem(KEY) || '[]');
  let dragSrc = null;
  let currentAlarm = null;

  const newText    = document.getElementById('new-text'),
        newDate    = document.getElementById('new-date'),
        newTime    = document.getElementById('new-time'),
        newCat     = document.getElementById('new-category'),
        newPrio    = document.getElementById('new-priority'),
        newRepeat  = document.getElementById('new-repeat'),
        addBtn     = document.getElementById('add-btn'),
        searchInp  = document.getElementById('search'),
        filterCat  = document.getElementById('filter-category'),
        filterPrio = document.getElementById('filter-priority'),
        listEl     = document.getElementById('task-list'),
        alarmDialog= document.getElementById('alarm-dialog'),
        alarmText  = document.getElementById('alarm-text'),
        snoozeBtn  = document.getElementById('snooze-btn'),
        dismissBtn = document.getElementById('dismiss-btn');

  function save() {
    localStorage.setItem(KEY, JSON.stringify(tasks));
    render();
  }

  function bindDrag(li, i) {
    li.draggable = true;
    li.addEventListener('dragstart', () => dragSrc = i);
    li.addEventListener('dragover', e => e.preventDefault());
    li.addEventListener('drop', () => {
      tasks.splice(i, 0, tasks.splice(dragSrc, 1)[0]);
      save();
    });
  }

  // check for due tasks every 10s
  setInterval(() => {
    const now = new Date();
    tasks.forEach(t => {
      if (!t.done && t.date && t.time && !t.rung && !currentAlarm) {
        const due = new Date(`${t.date}T${t.time}`);
        if (due <= now) {
          t.rung = true;
          currentAlarm = t;
          alarmText.textContent = t.text;
          alarmDialog.classList.remove('hidden');
          new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
          save();
        }
      }
    });
  }, 10000);

  function render() {
    // clear list
    listEl.innerHTML = '';

    // sort: unchecked first, then by date+time
    tasks.sort((a, b) => {
      if (a.done !== b.done) return a.done ? 1 : -1;
      const dtA = new Date(`${a.date}T${a.time || '00:00'}`);
      const dtB = new Date(`${b.date}T${b.time || '00:00'}`);
      return dtA - dtB;
    });

    const q = searchInp.value.toLowerCase();
    tasks.forEach((t, i) => {
      // filters
      if (q && !t.text.toLowerCase().includes(q)) return;
      if (filterCat.value !== 'All Categories' && t.category !== filterCat.value) return;
      if (filterPrio.value !== 'All Priorities' && t.priority !== filterPrio.value) return;

      // list item
      const li = document.createElement('li');
      li.className = `
        bg-white/90 dark:bg-gray-800/90
        backdrop-blur-md rounded-2xl p-6 shadow-lg
        grid grid-cols-[auto_1fr_auto] gap-4 items-start
        transition hover:scale-[1.02] duration-300
        ${t.done ? 'opacity-50' : ''}
      `.trim();

      li.innerHTML = `
        <input type="checkbox" ${t.done ? 'checked' : ''} class="h-6 w-6 mt-1"/>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold ${t.done ? 'line-through' : ''}">${t.text}</h3>
            <div class="flex space-x-3 text-2xl">
              <button data-act="note">üìù</button>
              <button data-act="del" class="text-red-500">üóëÔ∏è</button>
              <button data-act="share-whatsapp" class="text-green-500">üì§</button>
              <button data-act="share-email" class="text-blue-500">‚úâÔ∏è</button>
            </div>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">
            <span class="font-semibold text-indigo-600 dark:text-indigo-400">${t.category}</span>
            ‚Ä¢ ${t.date || ''} ${t.time || ''}
            ‚Ä¢ <span class="px-2 py-0.5 rounded-full ${
              t.priority==='high'? 'bg-red-200 text-red-700' :
              t.priority==='med'?  'bg-yellow-200 text-yellow-700' :
                                   'bg-green-200 text-green-700'
            }">${t.priority.charAt(0).toUpperCase() + t.priority.slice(1)}</span>
          </div>
          <div class="notes-area ${t.editing ? '' : 'hidden'} mt-3 space-y-2">
            <!-- rich-text toolbar & editor -->
            <div class="flex space-x-2 mb-2">
              <button onclick="exec('bold')"      class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">B</button>
              <button onclick="exec('italic')"    class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">I</button>
              <button onclick="exec('underline')" class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">U</button>
              <select onchange="exec('fontSize',this.value)" class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">
                <option value="3">Normal</option><option value="5">Large</option><option value="7">Huge</option>
              </select>
              <button onclick="exec('justifyLeft')"   class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">L</button>
              <button onclick="exec('justifyCenter')" class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">C</button>
              <button onclick="exec('justifyRight')"  class="px-2 py-1 bg-indigo-100 dark:bg-indigo-700 rounded">R</button>
              <input type="color" onchange="exec('foreColor',this.value)"
                     class="w-6 h-6 p-0 border-none"/>
            </div>
            <div contenteditable="true"
                 class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600
                        focus:ring-indigo-400 focus:outline-none transition
                        bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 note-editor">
              ${t.notes || ''}
            </div>
            <button class="px-3 py-1 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition save-note">
              Save Note
            </button>
            <button class="px-3 py-1 bg-green-500 text-white rounded-xl hover:bg-green-600 transition share-whatsapp">
              üì§
            </button>
            <button class="px-3 py-1 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition share-email">
              ‚úâÔ∏è
            </button>
          </div>
          ${t.notes && !t.editing
            ? `<div class="mt-2 text-sm bg-white/70 dark:bg-gray-700 p-3 rounded-lg">
                 ${t.notes}
               </div>`
            : ''
          }
        </div>
      `.trim();

      // checkbox toggle
      const chk = li.querySelector('input[type="checkbox"]');
      chk.onchange = () => { t.done = chk.checked; save(); };

      // note / delete / share handlers
      li.querySelector('button[data-act="note"]').onclick = () => { t.editing = true; save(); };
      li.querySelector('button[data-act="del"]').onclick  = () => { tasks.splice(i,1); save(); };

      const shareWp = li.querySelector('button[data-act="share-whatsapp"]');
      shareWp.onclick = () => {
        const div = document.createElement('div');
        div.innerHTML = t.notes || '';
        const notes = div.textContent || div.innerText;
        const msg = `*Task:* ${t.text}\n*Category:* ${t.category}\n*Due:* ${t.date} ${t.time}\n*Priority:* ${t.priority}\n*Notes:* ${notes}`;
        window.open('https://wa.me/?text=' + encodeURIComponent(msg));
      };

      const shareEm = li.querySelector('button[data-act="share-email"]');
      shareEm.onclick = () => {
        const div = document.createElement('div');
        div.innerHTML = t.notes || '';
        const notes = div.textContent || div.innerText;
        window.location.href = `mailto:?subject=${encodeURIComponent('Task: ' + t.text)}&body=${encodeURIComponent('Category: ' + t.category + '\nDue: ' + t.date + ' ' + t.time + '\nPriority: ' + t.priority + '\nNotes: ' + notes)}`;
      };

      // rich-text exec helper
      window.exec = (cmd, val) => document.execCommand(cmd, false, val);

      // notes save/share
      const notesArea = li.querySelector('.notes-area');
      const editor    = notesArea.querySelector('.note-editor');
      notesArea.querySelector('.save-note').onclick         = () => { t.notes = editor.innerHTML; t.editing = false; save(); };
      notesArea.querySelector('.share-whatsapp').onclick    = shareWp.onclick;
      notesArea.querySelector('.share-email').onclick       = shareEm.onclick;

      bindDrag(li, i);
      listEl.appendChild(li);
    });
  }

  addBtn.onclick = () => {
    const t = {
      text:     newText.value.trim(),
      date:     newDate.value,
      time:     newTime.value,
      category: newCat.value,
      priority: newPrio.value,
      repeat:   newRepeat.value,
      notes:    '',
      done:     false,
      rung:     false,
      editing:  false
    };
    if (!t.text) return;
    tasks.push(t);
    [newText, newDate, newTime].forEach(e => e.value = '');
    newCat.value    = 'General';
    newPrio.value   = 'low';
    newRepeat.value = 'none';
    save();
    if ('Notification' in window) {
      new Notification('Task added', { body: t.text });
    }
  };

  [searchInp, filterCat, filterPrio].forEach(el => {
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });

  snoozeBtn.onclick = () => {
    if (currentAlarm) currentAlarm.rung = false;
    alarmDialog.classList.add('hidden');
    currentAlarm = null;
  };
  dismissBtn.onclick = () => {
    alarmDialog.classList.add('hidden');
    currentAlarm = null;
  };

  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  save();
});
